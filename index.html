<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Verse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .theme-dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .theme-dark .bg-white {
            background-color: #2d3748;
        }
        .theme-dark .text-gray-800 {
            color: #e2e8f0;
        }
        .theme-dark .text-gray-500 {
            color: #a0aec0;
        }
        .theme-dark input, .theme-dark textarea {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .theme-dark input::placeholder, .theme-dark textarea::placeholder {
            color: #a0aec0;
        }
        .theme-dark .border-gray-300 {
            border-color: #4a5568;
        }
        .theme-dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        .verse-card {
            background-size: cover;
            background-position: center;
        }
        .verse-card:hover {
            transform: scale(1.03);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 transition-colors duration-300">
    <!-- Main Container -->
    <div id="main-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8 space-y-8 transition-colors duration-300">
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-5xl font-extrabold text-blue-600">Find a Verse</h1>
            <p class="text-gray-500">Get a verse that speaks to your heart.</p>
        </header>

        <!-- User Profile Section -->
        <section id="profile-section" class="border-t border-gray-300 pt-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">My Profile</h2>
                <button id="profile-toggle-button" class="text-blue-600 hover:text-blue-800 transition-colors duration-300 text-sm font-semibold">Hide</button>
            </div>
            <div id="profile-content" class="mt-4 space-y-4">
                <div id="loading-profile" class="flex justify-center items-center h-24">
                    <div class="loading-spinner"></div>
                </div>
                <div id="profile-form" class="hidden space-y-4">
                    <input id="profile-name" type="text" placeholder="Your Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <textarea id="profile-bio" rows="3" placeholder="A short bio..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    <button id="profile-save-button" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors duration-300 font-bold shadow-md">Save Profile</button>
                    <p id="user-id" class="text-center text-gray-500 text-xs mt-2"></p>
                </div>
            </div>
        </section>

        <!-- The Verse of the Day Section -->
        <section class="border-t border-gray-300 pt-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Verse of the Day</h2>
            <div id="verse-of-day" class="p-6 bg-blue-500 text-white rounded-2xl shadow-md space-y-2 text-center transition-transform duration-300">
                <div id="votd-text" class="text-lg font-medium italic">Loading verse...</div>
                <div id="votd-reference" class="text-sm font-semibold"></div>
            </div>
        </section>

        <!-- Mood-Based Verses Section -->
        <section class="border-t border-gray-300 pt-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Find a Verse by Emotion</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <button data-emotion="joy" class="verse-card bg-green-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/22c55e/ffffff?text=Joy');">Joy</button>
                <button data-emotion="peace" class="verse-card bg-purple-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/a855f7/ffffff?text=Peace');">Peace</button>
                <button data-emotion="sadness" class="verse-card bg-blue-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/3b82f6/ffffff?text=Sadness');">Sadness</button>
                <button data-emotion="fear" class="verse-card bg-orange-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/f97316/ffffff?text=Fear');">Fear</button>
                <button data-emotion="anger" class="verse-card bg-red-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/ef4444/ffffff?text=Anger');">Anger</button>
                <button data-emotion="strength" class="verse-card bg-indigo-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105" style="background-image: url('https://placehold.co/400x200/6366f1/ffffff?text=Strength');">Strength</button>
            </div>
            <div id="verse-result" class="mt-4 p-6 bg-gray-50 rounded-2xl shadow-md space-y-2 hidden">
                <p id="result-text" class="text-gray-800 text-lg italic"></p>
                <p id="result-reference" class="text-gray-500 text-sm font-semibold text-right"></p>
            </div>
        </section>

        <!-- Theme and Font Size Controls -->
        <section class="border-t border-gray-300 pt-6 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span class="text-gray-800 font-semibold">Font Size:</span>
                <div class="flex items-center space-x-2">
                    <button id="font-decrease" class="p-2 w-8 h-8 flex justify-center items-center text-gray-500 rounded-full border border-gray-300 hover:bg-gray-200 transition-colors duration-300">-</button>
                    <button id="font-increase" class="p-2 w-8 h-8 flex justify-center items-center text-gray-500 rounded-full border border-gray-300 hover:bg-gray-200 transition-colors duration-300">+</button>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-800 font-semibold">Theme:</span>
                <button id="theme-toggle" class="p-2 w-12 h-6 flex items-center rounded-full bg-gray-300 transition-colors duration-300">
                    <div class="w-4 h-4 rounded-full bg-white shadow-md transform transition-transform duration-300"></div>
                </button>
            </div>
        </section>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI element references
        const profileToggleButton = document.getElementById('profile-toggle-button');
        const profileContent = document.getElementById('profile-content');
        const loadingProfile = document.getElementById('loading-profile');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileBioInput = document.getElementById('profile-bio');
        const profileSaveButton = document.getElementById('profile-save-button');
        const userIdDisplay = document.getElementById('user-id');
        const verseOfDayText = document.getElementById('votd-text');
        const verseOfDayReference = document.getElementById('votd-reference');
        const verseResultContainer = document.getElementById('verse-result');
        const resultText = document.getElementById('result-text');
        const resultReference = document.getElementById('result-reference');
        const themeToggleButton = document.getElementById('theme-toggle');
        const themeToggleCircle = themeToggleButton.querySelector('div');
        const body = document.body;
        const fontIncreaseButton = document.getElementById('font-increase');
        const fontDecreaseButton = document.getElementById('font-decrease');
        const mainContainer = document.getElementById('main-container');

        // Firebase variables
        let db, auth;
        let userId;
        let profileRef;

        // Verses data (simplified for this example)
        const verses = {
            joy: {
                text: "The Lord is my strength and my shield; in Him my heart trusts, and I am helped; my heart exults, and with my song I give thanks to Him.",
                reference: "Psalm 28:7"
            },
            peace: {
                text: "Peace I leave with you; my peace I give you. I do not give to you as the world gives. Do not let your hearts be troubled and do not be afraid.",
                reference: "John 14:27"
            },
            sadness: {
                text: "The Lord is close to the brokenhearted and saves those who are crushed in spirit.",
                reference: "Psalm 34:18"
            },
            fear: {
                text: "For God has not given us a spirit of fear, but of power and of love and of a sound mind.",
                reference: "2 Timothy 1:7"
            },
            anger: {
                text: "A fool gives full vent to his anger, but a wise man keeps himself under control.",
                reference: "Proverbs 29:11"
            },
            strength: {
                text: "I can do all things through him who strengthens me.",
                reference: "Philippians 4:13"
            },
            votd: {
                text: "For where two or three are gathered in my name, there am I among them.",
                reference: "Matthew 18:20"
            }
        };

        // Initialize Firebase and Auth
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Start authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        await loadUserProfile();
                    } else {
                        await signInAnonymously(auth);
                    }
                });

                // Authenticate with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingProfile.classList.add('hidden');
                profileForm.classList.remove('hidden');
                profileForm.innerHTML = `<p class="text-red-500 text-center">Error loading profile. Check the console for details.</p>`;
            }
        };

        // Profile and Settings Management
        const loadUserProfile = async () => {
            loadingProfile.classList.add('hidden');
            profileForm.classList.remove('hidden');

            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profileNameInput.value = data.name || '';
                    profileBioInput.value = data.bio || '';
                    if (data.darkMode) {
                        body.classList.add('theme-dark');
                        themeToggleCircle.classList.add('translate-x-full', '!bg-blue-600');
                        themeToggleButton.classList.add('bg-gray-600');
                    } else {
                        body.classList.remove('theme-dark');
                        themeToggleCircle.classList.remove('translate-x-full', '!bg-blue-600');
                        themeToggleButton.classList.remove('bg-gray-600');
                    }
                    if (data.fontSize) {
                        mainContainer.style.fontSize = `${data.fontSize}px`;
                    }
                }
            }, (error) => {
                console.error("Error fetching profile:", error);
            });
        };

        const saveUserProfile = async () => {
            if (!profileRef) return;
            try {
                const darkMode = body.classList.contains('theme-dark');
                const fontSize = parseFloat(getComputedStyle(mainContainer).fontSize);
                await setDoc(profileRef, {
                    name: profileNameInput.value,
                    bio: profileBioInput.value,
                    darkMode: darkMode,
                    fontSize: fontSize
                }, { merge: true });
                console.log("Profile saved successfully!");
            } catch (error) {
                console.error("Error saving profile:", error);
            }
        };

        // Event listeners
        profileToggleButton.addEventListener('click', () => {
            if (profileContent.classList.contains('hidden')) {
                profileContent.classList.remove('hidden');
                profileToggleButton.textContent = 'Hide';
            } else {
                profileContent.classList.add('hidden');
                profileToggleButton.textContent = 'Show';
            }
        });

        profileSaveButton.addEventListener('click', saveUserProfile);

        document.querySelectorAll('.verse-card').forEach(button => {
            button.addEventListener('click', (e) => {
                const emotion = e.target.dataset.emotion;
                const verse = verses[emotion];
                if (verse) {
                    resultText.textContent = `“${verse.text}”`;
                    resultReference.textContent = `— ${verse.reference}`;
                    verseResultContainer.classList.remove('hidden');
                }
            });
        });

        themeToggleButton.addEventListener('click', () => {
            body.classList.toggle('theme-dark');
            themeToggleCircle.classList.toggle('translate-x-full');
            themeToggleCircle.classList.toggle('!bg-blue-600');
            themeToggleButton.classList.toggle('bg-gray-600');
            saveUserProfile();
        });

        fontIncreaseButton.addEventListener('click', () => {
            const currentSize = parseFloat(getComputedStyle(mainContainer).fontSize);
            mainContainer.style.fontSize = `${currentSize + 1}px`;
            saveUserProfile();
        });

        fontDecreaseButton.addEventListener('click', () => {
            const currentSize = parseFloat(getComputedStyle(mainContainer).fontSize);
            mainContainer.style.fontSize = `${currentSize - 1}px`;
            saveUserProfile();
        });

        // Set the Verse of the Day on load
        verseOfDayText.textContent = `“${verses.votd.text}”`;
        verseOfDayReference.textContent = `— ${verses.votd.reference}`;

        // Initialize the app on window load
        window.onload = initFirebase;
    </script>
</body>
</html>
