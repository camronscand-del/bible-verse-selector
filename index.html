<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Verse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* --- Themes --- */
        .theme-light {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .theme-light .bg-white { background-color: #ffffff; }
        .theme-light .text-gray-800 { color: #1f2937; }
        .theme-light .text-gray-500 { color: #6b7280; }
        .theme-light .bg-gray-100 { background-color: #f9fafb; }
        .theme-light input, .theme-light textarea { background-color: #ffffff; border-color: #d1d5db; color: #1f2937; }
        .theme-light input::placeholder, .theme-light textarea::placeholder { color: #9ca3af; }
        .theme-light .border-gray-300 { border-color: #d1d5db; }
        .theme-light .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        .theme-dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .theme-dark .bg-white { background-color: #2d3748; }
        .theme-dark .bg-gray-100 { background-color: #4a5568; }
        .theme-dark .text-gray-800 { color: #e2e8f0; }
        .theme-dark .text-gray-500 { color: #a0aec0; }
        .theme-dark input, .theme-dark textarea { background-color: #4a5568; border-color: #4a5568; color: #e2e8f0; }
        .theme-dark input::placeholder, .theme-dark textarea::placeholder { color: #a0aec0; }
        .theme-dark .border-gray-300 { border-color: #4a5568; }
        .theme-dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12); }
        
        .theme-ocean {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .theme-ocean .bg-white { background-color: #dbeafe; }
        .theme-ocean .bg-gray-100 { background-color: #eff6ff; }
        .theme-ocean .text-gray-800 { color: #0c4a6e; }
        .theme-ocean .text-gray-500 { color: #3b82f6; }
        .theme-ocean input, .theme-ocean textarea { background-color: #eff6ff; border-color: #93c5fd; color: #0c4a6e; }
        .theme-ocean input::placeholder, .theme-ocean textarea::placeholder { color: #93c5fd; }
        .theme-ocean .border-gray-300 { border-color: #93c5fd; }
        .theme-ocean .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .theme-ocean .bg-blue-600 { background-color: #1d4ed8; }

        .theme-forest-green {
            background-color: #f0fdf4;
            color: #166534;
        }
        .theme-forest-green .bg-white { background-color: #dcfce7; }
        .theme-forest-green .bg-gray-100 { background-color: #dcfce7; }
        .theme-forest-green .text-gray-800 { color: #166534; }
        .theme-forest-green .text-gray-500 { color: #4ade80; }
        .theme-forest-green input, .theme-forest-green textarea { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .theme-forest-green input::placeholder, .theme-forest-green textarea::placeholder { color: #bbf7d0; }
        .theme-forest-green .border-gray-300 { border-color: #bbf7d0; }
        .theme-forest-green .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .theme-forest-green .bg-blue-600 { background-color: #15803d; }
        .theme-forest-green .text-blue-600 { color: #15803d; }
        
        .verse-card:hover {
            transform: scale(1.03);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 transition-colors duration-300">
    <!-- Main Container -->
    <div id="main-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8 space-y-8 transition-colors duration-300">
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-5xl font-extrabold text-blue-600">Find a Verse</h1>
            <p class="text-gray-500">Get a verse that speaks to your heart.</p>
        </header>

        <!-- User Profile Section -->
        <section id="profile-section" class="border-t border-gray-300 pt-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">My Profile</h2>
                <button id="profile-toggle-button" class="text-blue-600 hover:text-blue-800 transition-colors duration-300 text-sm font-semibold">Hide</button>
            </div>
            <div id="profile-content" class="mt-4 space-y-4">
                <div id="loading-profile" class="flex justify-center items-center h-24">
                    <div class="loading-spinner"></div>
                </div>
                <div id="profile-form" class="hidden space-y-4">
                    <input id="profile-name" type="text" placeholder="Your Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <textarea id="profile-bio" rows="3" placeholder="A short bio..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                    <button id="profile-save-button" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors duration-300 font-bold shadow-md">Save Profile</button>
                    <p id="user-id" class="text-center text-gray-500 text-xs mt-2"></p>
                </div>
            </div>
        </section>

        <!-- The Verse of the Day Section -->
        <section class="border-t border-gray-300 pt-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Verse of the Day</h2>
            <div id="verse-of-day" class="p-6 bg-blue-500 text-white rounded-2xl shadow-md space-y-2 text-center transition-transform duration-300">
                <div id="votd-text" class="text-lg font-medium italic">Loading verse...</div>
                <div id="votd-reference" class="text-sm font-semibold"></div>
            </div>
        </section>

        <!-- Mood-Based Verses Section -->
        <section class="border-t border-gray-300 pt-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Find a Verse by Emotion</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <button data-emotion="joy" class="verse-card bg-green-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Joy</button>
                <button data-emotion="peace" class="verse-card bg-purple-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Peace</button>
                <button data-emotion="sadness" class="verse-card bg-blue-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Sadness</button>
                <button data-emotion="fear" class="verse-card bg-orange-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Fear</button>
                <button data-emotion="anger" class="verse-card bg-red-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Anger</button>
                <button data-emotion="strength" class="verse-card bg-indigo-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Strength</button>
                <button data-emotion="hope" class="verse-card bg-amber-500 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Hope</button>
                <button data-emotion="gratitude" class="verse-card bg-pink-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Gratitude</button>
                <button data-emotion="healing" class="verse-card bg-teal-400 text-white p-6 rounded-xl shadow-md font-bold text-center transition-transform duration-300 hover:scale-105">Healing</button>
            </div>
            <div id="random-verse-container" class="mt-4">
                 <button id="random-verse-button" class="w-full bg-gray-300 text-gray-800 p-3 rounded-lg hover:bg-gray-400 transition-colors duration-300 font-bold shadow-md">Get a Random Verse</button>
            </div>
            <div id="verse-result" class="mt-4 p-6 bg-gray-100 rounded-2xl shadow-md space-y-2 hidden">
                <p id="result-text" class="text-gray-800 text-lg italic"></p>
                <p id="result-reference" class="text-gray-500 text-sm font-semibold text-right"></p>
                <div class="text-center pt-2">
                    <a id="bible-link" href="#" target="_blank" class="text-blue-600 hover:underline text-sm font-semibold">Read on Bible Gateway</a>
                </div>
            </div>
        </section>

        <!-- Theme and Font Size Controls -->
        <section class="border-t border-gray-300 pt-6 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span class="text-gray-800 font-semibold">Font Size:</span>
                <div class="flex items-center space-x-2">
                    <button id="font-decrease" class="p-2 w-8 h-8 flex justify-center items-center text-gray-500 rounded-full border border-gray-300 hover:bg-gray-200 transition-colors duration-300">-</button>
                    <button id="font-increase" class="p-2 w-8 h-8 flex justify-center items-center text-gray-500 rounded-full border border-gray-300 hover:bg-gray-200 transition-colors duration-300">+</button>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2" id="theme-controls">
                <span class="text-gray-800 font-semibold">Themes:</span>
                <div class="flex space-x-2">
                    <button data-theme="light" class="w-8 h-8 rounded-full bg-white border border-gray-300 hover:ring-2 hover:ring-blue-500 transition-all"></button>
                    <button data-theme="dark" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-300 hover:ring-2 hover:ring-blue-500 transition-all"></button>
                    <button data-theme="ocean" class="w-8 h-8 rounded-full bg-blue-300 border border-gray-300 hover:ring-2 hover:ring-blue-500 transition-all"></button>
                    <button data-theme="forest-green" class="w-8 h-8 rounded-full bg-green-500 border border-gray-300 hover:ring-2 hover:ring-green-700 transition-all"></button>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI element references
        const profileToggleButton = document.getElementById('profile-toggle-button');
        const profileContent = document.getElementById('profile-content');
        const loadingProfile = document.getElementById('loading-profile');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileBioInput = document.getElementById('profile-bio');
        const profileSaveButton = document.getElementById('profile-save-button');
        const userIdDisplay = document.getElementById('user-id');
        const verseOfDayText = document.getElementById('votd-text');
        const verseOfDayReference = document.getElementById('votd-reference');
        const verseResultContainer = document.getElementById('verse-result');
        const resultText = document.getElementById('result-text');
        const resultReference = document.getElementById('result-reference');
        const bibleLink = document.getElementById('bible-link');
        const themeControls = document.getElementById('theme-controls');
        const body = document.body;
        const fontIncreaseButton = document.getElementById('font-increase');
        const fontDecreaseButton = document.getElementById('font-decrease');
        const randomVerseButton = document.getElementById('random-verse-button');
        const mainContainer = document.getElementById('main-container');

        // Firebase variables
        let db, auth;
        let userId;
        let profileRef;
        const THEMES = ['light', 'dark', 'ocean', 'forest-green'];

        // Verses data
        const verses = {
            joy: { text: "The Lord is my strength and my shield; in Him my heart trusts, and I am helped; my heart exults, and with my song I give thanks to Him.", reference: "Psalm 28:7" },
            peace: { text: "Peace I leave with you; my peace I give you. I do not give to you as the world gives. Do not let your hearts be troubled and do not be afraid.", reference: "John 14:27" },
            sadness: { text: "The Lord is close to the brokenhearted and saves those who are crushed in spirit.", reference: "Psalm 34:18" },
            fear: { text: "For God has not given us a spirit of fear, but of power and of love and of a sound mind.", reference: "2 Timothy 1:7" },
            anger: { text: "A fool gives full vent to his anger, but a wise man keeps himself under control.", reference: "Proverbs 29:11" },
            strength: { text: "I can do all things through him who strengthens me.", reference: "Philippians 4:13" },
            hope: { text: "May the God of hope fill you with all joy and peace as you trust in him, so that you may overflow with hope by the power of the Holy Spirit.", reference: "Romans 15:13" },
            gratitude: { text: "Give thanks in all circumstances; for this is God’s will for you in Christ Jesus.", reference: "1 Thessalonians 5:18" },
            healing: { text: "Heal me, O Lord, and I shall be healed; save me, and I shall be saved, for you are my praise.", reference: "Jeremiah 17:14" },
            votd: { text: "For where two or three are gathered in my name, there am I among them.", reference: "Matthew 18:20" }
        };

        // Initialize Firebase and Auth
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Start authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        await loadUserProfile();
                    } else {
                        await signInAnonymously(auth);
                    }
                });

                // Authenticate with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingProfile.classList.add('hidden');
                profileForm.classList.remove('hidden');
                profileForm.innerHTML = `<p class="text-red-500 text-center">Error loading profile. Check the console for details.</p>`;
            }
        };

        // Profile and Settings Management
        const loadUserProfile = async () => {
            loadingProfile.classList.add('hidden');
            profileForm.classList.remove('hidden');

            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profileNameInput.value = data.name || '';
                    profileBioInput.value = data.bio || '';
                    applyTheme(data.theme || 'light');
                    if (data.fontSize) {
                        mainContainer.style.fontSize = `${data.fontSize}px`;
                    }
                } else {
                    applyTheme('light');
                }
            }, (error) => {
                console.error("Error fetching profile:", error);
            });
        };

        const saveUserProfile = async () => {
            if (!profileRef) return;
            try {
                const currentTheme = body.dataset.theme || 'light';
                const fontSize = parseFloat(getComputedStyle(mainContainer).fontSize);
                await setDoc(profileRef, {
                    name: profileNameInput.value,
                    bio: profileBioInput.value,
                    theme: currentTheme,
                    fontSize: fontSize
                }, { merge: true });
                console.log("Profile saved successfully!");
            } catch (error) {
                console.error("Error saving profile:", error);
            }
        };

        // Theme management
        const applyTheme = (themeName) => {
            // Remove all existing theme classes
            body.classList.remove('theme-light', 'theme-dark', 'theme-ocean', 'theme-forest-green');
            
            // Add the new theme class
            body.classList.add(`theme-${themeName}`);
            body.dataset.theme = themeName;
        };

        // Display a verse
        const displayVerse = (verse) => {
            // Explicitly clear existing text content to prevent overlap
            resultText.textContent = '';
            resultReference.textContent = '';
            
            resultText.textContent = `“${verse.text}”`;
            resultReference.textContent = `— ${verse.reference}`;
            bibleLink.href = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(verse.reference)}&version=NIV`;
            verseResultContainer.classList.remove('hidden');
        };

        // Event listeners
        profileToggleButton.addEventListener('click', () => {
            if (profileContent.classList.contains('hidden')) {
                profileContent.classList.remove('hidden');
                profileToggleButton.textContent = 'Hide';
            } else {
                profileContent.classList.add('hidden');
                profileToggleButton.textContent = 'Show';
            }
        });

        profileSaveButton.addEventListener('click', saveUserProfile);

        document.querySelectorAll('.verse-card').forEach(button => {
            button.addEventListener('click', (e) => {
                const emotion = e.target.dataset.emotion;
                const verse = verses[emotion];
                if (verse) {
                    displayVerse(verse);
                }
            });
        });

        randomVerseButton.addEventListener('click', () => {
            const verseKeys = Object.keys(verses);
            const randomKey = verseKeys[Math.floor(Math.random() * verseKeys.length)];
            const randomVerse = verses[randomKey];
            displayVerse(randomVerse);
        });

        themeControls.addEventListener('click', (e) => {
            const themeButton = e.target.closest('button');
            if (themeButton) {
                const theme = themeButton.dataset.theme;
                applyTheme(theme);
                saveUserProfile();
            }
        });

        fontIncreaseButton.addEventListener('click', () => {
            const currentSize = parseFloat(getComputedStyle(mainContainer).fontSize);
            mainContainer.style.fontSize = `${currentSize + 1}px`;
            saveUserProfile();
        });

        fontDecreaseButton.addEventListener('click', () => {
            const currentSize = parseFloat(getComputedStyle(mainContainer).fontSize);
            mainContainer.style.fontSize = `${currentSize - 1}px`;
            saveUserProfile();
        });

        // Set the Verse of the Day on load
        verseOfDayText.textContent = `“${verses.votd.text}”`;
        verseOfDayReference.textContent = `— ${verses.votd.reference}`;

        // Initialize the app on window load
        window.onload = initFirebase;
    </script>
</body>
</html>
